#include <stdint.h>

#define CONFIG_BT_EXT_ADV 0 // set to 1 to allow extended advertising

#define BEACON_SK_SIZE 512 // 4096 bits

typedef struct {
	uint8_t bytes[BEACON_SK_SIZE];
} beacon_sk_t;

// hard-coded beacon information for development purposes
#define BEACON_ID		0x012345678
#define BEACON_LOC_ID	0x0123456789abcdef
static beacon_sk_t BEACON_SK = {{
0xcb , 0x43 , 0xf7 , 0x56 , 0x16 , 0x25 , 0xb3 , 0xd0 , 0xd0 , 0xbe ,
0xad , 0xf4 , 0xca , 0x6c , 0xa6 , 0xd9 , 0x00 , 0xfd , 0x72 , 0xb2 ,
0x1f , 0xb5 , 0xd8 , 0x4e , 0xea , 0xc3 , 0x3f , 0x19 , 0x77 , 0x8f ,
0x05 , 0xf5 , 0x05 , 0x98 , 0x17 , 0x19 , 0xc8 , 0xfa , 0x49 , 0x9b ,
0x71 , 0xd4 , 0x04 , 0xea , 0x45 , 0x8f , 0xe2 , 0x94 , 0x2e , 0x5b ,
0x61 , 0xdc , 0x96 , 0xb3 , 0x6d , 0xae , 0xa1 , 0x9b , 0x61 , 0x0d ,
0x10 , 0x8f , 0xf1 , 0x4b , 0x83 , 0x91 , 0x74 , 0x57 , 0xf5 , 0x40 ,
0x1a , 0x36 , 0x3d , 0xe6 , 0x5d , 0x41 , 0x2d , 0x67 , 0xf3 , 0xea ,
0x57 , 0x31 , 0x1a , 0x4e , 0x77 , 0xf5 , 0x9d , 0xa1 , 0x25 , 0xdf ,
0xbb , 0xc2 , 0x60 , 0xb7 , 0x7f , 0xf0 , 0x77 , 0x05 , 0xe9 , 0xe4 ,
0x05 , 0x7e , 0x10 , 0x32 , 0x8c , 0xed , 0x1b , 0x77 , 0xac , 0x5c ,
0x17 , 0x11 , 0x49 , 0xbe , 0xfd , 0x28 , 0x83 , 0x99 , 0xfe , 0xf1 ,
0x32 , 0xc3 , 0x2e , 0x7a , 0x8a , 0x55 , 0xa5 , 0x8f , 0xfe , 0xd5 ,
0x05 , 0x00 , 0x09 , 0x51 , 0x18 , 0x90 , 0x3b , 0xa9 , 0x19 , 0x62 ,
0x65 , 0x57 , 0x97 , 0x1a , 0x49 , 0x24 , 0x8c , 0x1e , 0xb9 , 0xe4 ,
0xa8 , 0x19 , 0x04 , 0x2a , 0xa1 , 0x34 , 0xe2 , 0x9e , 0xd3 , 0x73 ,
0x6b , 0x6d , 0x61 , 0xf2 , 0xa2 , 0x04 , 0x66 , 0x23 , 0x06 , 0x11 ,
0xbf , 0xb5 , 0x34 , 0x5e , 0xf9 , 0xb8 , 0x72 , 0xf7 , 0xf6 , 0x00 ,
0x79 , 0x16 , 0x50 , 0xa4 , 0xee , 0x79 , 0x04 , 0xae , 0xe0 , 0x0f ,
0x71 , 0xd7 , 0x8e , 0x71 , 0x6d , 0x7c , 0x11 , 0x72 , 0x7a , 0xfa ,
0x4a , 0x19 , 0x09 , 0xb5 , 0x95 , 0x9c , 0x98 , 0x2f , 0xda , 0x01 ,
0xd5 , 0x0f , 0xc9 , 0xf8 , 0x87 , 0x39 , 0xaa , 0x0f , 0xcf , 0xb6 ,
0x38 , 0xfa , 0xb3 , 0x3b , 0x6e , 0xcc , 0xc3 , 0xd7 , 0x95 , 0x7c ,
0x79 , 0x62 , 0x65 , 0x4b , 0x74 , 0xa5 , 0x9b , 0xcd , 0x74 , 0xac ,
0x02 , 0xf7 , 0x66 , 0x89 , 0x6a , 0xe5 , 0x22 , 0x43 , 0x90 , 0x4f ,
0xc4 , 0x15 , 0x22 , 0xec , 0xca , 0xd7 , 0xc0 , 0x5d , 0x1f , 0x1b ,
0xa3 , 0x95 , 0x48 , 0x43 , 0x9e , 0xe7 , 0x01 , 0xb4 , 0xc3 , 0x7c ,
0x86 , 0x95 , 0x43 , 0x45 , 0xb9 , 0x28 , 0x85 , 0xce , 0x94 , 0xd7 ,
0x1b , 0x09 , 0xb7 , 0x47 , 0xee , 0xc1 , 0xa1 , 0xcb , 0x8e , 0x75 ,
0x6e , 0x6f , 0xbb , 0xf7 , 0x83 , 0x01 , 0x43 , 0x79 , 0xcb , 0x53 ,
0xd9 , 0xdb , 0xc7 , 0x62 , 0x7d , 0x9c , 0x36 , 0xe0 , 0x06 , 0xd7 ,
0x12 , 0xe1 , 0xbf , 0xd7 , 0x10 , 0xed , 0x9a , 0xb7 , 0x86 , 0x1b ,
0xe9 , 0x84 , 0x40 , 0xae , 0xf5 , 0x35 , 0x79 , 0x4e , 0xa3 , 0xc5 ,
0x5c , 0x79 , 0x46 , 0x34 , 0x0f , 0xa0 , 0xe8 , 0x6c , 0x2f , 0x49 ,
0x7d , 0x5d , 0xd3 , 0x9e , 0xe5 , 0xf7 , 0xab , 0xb1 , 0xd5 , 0xd9 ,
0x12 , 0x7c , 0x0f , 0xb0 , 0xa9 , 0xe2 , 0xc7 , 0x1e , 0x2d , 0xad ,
0xf6 , 0xcf , 0x15 , 0xa3 , 0x22 , 0x8a , 0x6c , 0x43 , 0x09 , 0xa2 ,
0x01 , 0xf5 , 0x3a , 0xb9 , 0xec , 0x78 , 0xe6 , 0xe9 , 0x57 , 0x08 ,
0xaf , 0x32 , 0x3c , 0x25 , 0xe9 , 0xfd , 0xbb , 0x1d , 0x10 , 0x9e ,
0x02 , 0xb8 , 0x8b , 0xa3 , 0x72 , 0x1b , 0xd7 , 0xae , 0xa4 , 0xc5 ,
0x0f , 0xb0 , 0x66 , 0x8d , 0x5b , 0x0e , 0xc8 , 0x4f , 0xe9 , 0x62 ,
0xb6 , 0x62 , 0x21 , 0xe0 , 0xb3 , 0x4a , 0xbe , 0xa0 , 0x84 , 0x94 ,
0x4a , 0xdb , 0xb1 , 0x07 , 0x54 , 0x97 , 0x80 , 0xb4 , 0x52 , 0x06 ,
0xdd , 0xc3 , 0x2f , 0x63 , 0xe6 , 0xdc , 0x31 , 0x34 , 0xce , 0x34 ,
0x4b , 0x35 , 0x27 , 0x27 , 0x1e , 0x35 , 0x47 , 0x4f , 0xb4 , 0xf0 ,
0x49 , 0x25 , 0xb6 , 0x17 , 0xd9 , 0xba , 0x21 , 0x66 , 0x28 , 0xbb ,
0xee , 0x59 , 0xbe , 0xed , 0x8c , 0xb4 , 0xf3 , 0x0e , 0x59 , 0x50 ,
0x84 , 0xc2 , 0x25 , 0xf3 , 0xa7 , 0x86 , 0x81 , 0x0e , 0x0f , 0xc4 ,
0xff , 0x03 , 0x18 , 0x22 , 0xb2 , 0x9b , 0x99 , 0x91 , 0x35 , 0xfd ,
0x7f , 0x87 , 0x41 , 0x00 , 0x1e , 0x2e , 0x5f , 0xa1 , 0xe7 , 0x63 ,
0x63 , 0xb6 , 0x1c , 0x1b , 0x09 , 0xaf , 0x3b , 0x05 , 0xe6 , 0x19 ,
0x7c , 0x7a
}};

#define BEACON_EPOCH_LENGTH			15	 // number of timer cycles in one epoch should correspond to 15 min in prod.
#define BEACON_TIMER_RESOLUTION		1000 // in ms TODO: should be 1 min in prod.

typedef uint32_t beacon_epoch_counter_t;

#define BEACON_EPH_ID_HASH_LEN 14		// number of trailing bytes used

typedef struct {
    uint8_t bytes[BEACON_EPH_ID_HASH_LEN];
} beacon_eph_id_t;

typedef uint64_t beacon_location_id_t;

typedef uint32_t beacon_timer_t;

typedef uint32_t beacon_id_t;

typedef struct {
    beacon_eph_id_t *eph;
    beacon_location_id_t *loc;
    beacon_id_t *b;
    beacon_timer_t *t;
} encounter_broadcast_t;

#define ENCOUNTER_BROADCAST_SIZE (      \
    BEACON_EPH_ID_HASH_LEN              \
       + sizeof(beacon_location_id_t)   \
       + sizeof(beacon_id_t)            \
       + sizeof(beacon_timer_t)         )

#define MAX_BROADCAST_SIZE 31

typedef struct {
    uint8_t bytes[MAX_BROADCAST_SIZE];
} encounter_broadcast_raw_t;

// epoch calculation
#define epoch_i(t, C) (beacon_epoch_counter_t)((t - C)/BEACON_EPOCH_LENGTH)

static int encode_encounter(encounter_broadcast_raw_t*, encounter_broadcast_t*);
static int decode_encounter(encounter_broadcast_t*, encounter_broadcast_raw_t*);

